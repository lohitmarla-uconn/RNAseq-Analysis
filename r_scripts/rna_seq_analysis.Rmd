---
title: "R Notebook"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r,  warning=FALSE, message=FALSE}

# ðŸ“Œ Load Required Libraries
library(DESeq2)
library(ggplot2)
library(dplyr)
library(clusterProfiler)
library(org.Mm.eg.db)  # Annotation database for mouse
library(ReactomePA)
library(EnhancedVolcano)
library(pheatmap)

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Load and Prepare Data
counts_df <- read.csv("C:/Users/lohit marla/Documents/RNAseq-Analysis/data/rna_seq_counts_matrix.csv", row.names = 1)
metadata_df <- read.csv("C:/Users/lohit marla/Documents/RNAseq-Analysis/conf/metadata.csv", row.names = 1)

metadata_df$type <- as.factor(metadata_df$type)  # Ensure sample type is a factor

# Function to filter out unwanted genes (e.g., non-coding genes)
is_unwanted_gene <- function(gene_name) {
  if (grepl("^(GM|gm|Gm|IG|ig|Ig)", gene_name) || tolower(gene_name) %>% endsWith("rik")) return(TRUE)
  return(FALSE)
}

# Filter unwanted genes
filtered_counts_df <- counts_df[!sapply(rownames(counts_df), is_unwanted_gene), ]

# Match sample names
common_samples <- intersect(colnames(filtered_counts_df), rownames(metadata_df))
filtered_counts_df <- filtered_counts_df[, common_samples]
metadata_df <- metadata_df[common_samples, ]

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Differential Expression Analysis using DESeq2
dds <- DESeqDataSetFromMatrix(countData = filtered_counts_df, colData = metadata_df, design = ~ type)
dds <- DESeq(dds)
res <- results(dds)

# ðŸ“Œ Identify Significant Differentially Expressed Genes (DEGs)
alpha <- 0.05  # Adjusted p-value threshold
log2_fc_threshold <- 1.0  # Fold change threshold

significant_genes_df <- res %>%
  as.data.frame() %>%
  filter(padj < alpha & abs(log2FoldChange) >= log2_fc_threshold)

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Volcano Plot for Differential Expression
ggplot(res, aes(x = log2FoldChange, y = -log10(padj))) +
  geom_point(aes(color = rownames(res) %in% rownames(significant_genes_df)), alpha = 0.5) +
  scale_color_manual(values = c("TRUE" = "red", "FALSE" = "blue")) +
  geom_hline(yintercept = -log10(alpha), linetype = "dashed", color = "grey") +
  geom_vline(xintercept = c(-log2_fc_threshold, log2_fc_threshold), linetype = "dashed", color = "grey") +
  labs(title = "Volcano Plot of Differential Expression", x = "Log2 Fold Change", y = "-Log10 Adjusted P-Value") +
  theme_minimal()

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Enhanced Volcano Plot
EnhancedVolcano(res,
                lab = rownames(res),
                x = 'log2FoldChange',
                y = 'pvalue',
                title = 'Volcano Plot of Differentially Expressed Genes',
                pCutoff = alpha,
                FCcutoff = log2_fc_threshold,
                pointSize = 3.0,
                labSize = 3.0)

```

```{r}
# ðŸ“Œ Perform Variance-Stabilizing Transformation (VST)
vsd <- vst(dds, blind = FALSE)  # Transform DESeq2 data to stabilize variance

# ðŸ“Œ Extract PCA Data
pca_data <- plotPCA(vsd, intgroup = "type", returnData = TRUE)

# Compute % variance explained by each principal component (PC)
percentVar <- round(100 * attr(pca_data, "percentVar"))

# ðŸ“Œ Generate PCA Plot
ggplot(pca_data, aes(PC1, PC2, color=type)) +
    geom_point(size=4, alpha=0.8) +
    labs(title = "PCA Plot of RNA-Seq Samples",
         x = paste0("PC1: ", percentVar[1], "% variance"),
         y = paste0("PC2: ", percentVar[2], "% variance")) +
    theme_minimal() +
    theme(text = element_text(size=14))
```
```{r,  warning=FALSE, message=FALSE}

# ðŸ“Œ Heatmap of Top 50 Significant Genes
top50 <- rownames(significant_genes_df[order(significant_genes_df$padj), ])[1:50]
normalized_counts <- counts(dds, normalized=TRUE)
heatmap_data <- normalized_counts[top50,]

pheatmap(heatmap_data, scale="row", clustering_distance_rows="correlation", clustering_distance_cols="correlation", fontsize_row = 4)

```
```{r,  warning=FALSE, message=FALSE}

# ðŸ“Œ GO Enrichment Analysis for Mouse
gene_ids <- bitr(rownames(significant_genes_df), fromType="SYMBOL", toType="ENTREZID", OrgDb=org.Mm.eg.db)
go_results <- enrichGO(gene=gene_ids$ENTREZID, OrgDb=org.Mm.eg.db, ont="BP", pAdjustMethod="BH")
write.csv(go_results@result, "GO_enrichment_results_mouse.csv")

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ KEGG Pathway Enrichment Analysis (Mouse)
kegg_results <- enrichKEGG(gene=gene_ids$ENTREZID, organism="mmu")
write.csv(kegg_results@result, "KEGG_enrichment_results_mouse.csv")

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Reactome Pathway Enrichment Analysis (Mouse)
reactome_results <- enrichPathway(gene=gene_ids$ENTREZID, organism="mouse")
write.csv(reactome_results@result, "Reactome_enrichment_results_mouse.csv")

# ðŸ“Œ Plot GO Enrichment with Smaller Font
dotplot(go_results, showCategory=10, title="GO Biological Process Enrichment") +
  theme(
    axis.text.x = element_text(size = 8),  # Reduce x-axis font size
    axis.text.y = element_text(size = 8),  # Reduce y-axis font size
    plot.title = element_text(size = 10),  # Reduce title size
    legend.text = element_text(size = 8),  # Reduce legend font size
    legend.title = element_text(size = 9)  # Reduce legend title size
  )

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Plot KEGG Pathway Enrichment with Smaller Font
dotplot(kegg_results, showCategory=10, title="KEGG Pathway Enrichment - Mouse") +
  theme(
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    plot.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9)
  )

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Plot Reactome Pathway Enrichment with Smaller Font
dotplot(reactome_results, showCategory=10, title="Reactome Pathway Enrichment - Mouse") +
  theme(
    axis.text.x = element_text(size = 8),
    axis.text.y = element_text(size = 8),
    plot.title = element_text(size = 10),
    legend.text = element_text(size = 8),
    legend.title = element_text(size = 9)
  )

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Identify Cancer-Related DEGs
cancer_genes <- c("Tp53", "Myc", "Akt1", "Pten", "Cdkn2a", "Rb1")  # Add relevant genes
cancer_degs <- significant_genes_df[rownames(significant_genes_df) %in% cancer_genes, ]
write.csv(cancer_degs, "cancer_related_DEGs_mouse.csv")

```
```{r,  warning=FALSE, message=FALSE}
# ðŸ“Œ Extract top 10 significant GO terms based on adjusted p-value
top_go_terms <- go_results@result[order(go_results@result$p.adjust), ][1:10, ]

# ðŸ“Œ Visualize GO Enrichment Bar Plot
ggplot(top_go_terms, aes(x=reorder(Description, -log10(p.adjust)), y=-log10(p.adjust))) +
  geom_bar(stat="identity", fill="blue") +
  coord_flip() +
  labs(title="Top 10 Enriched GO Terms", x="GO Term", y="-Log10 Adjusted P-Value") +
  theme_minimal()

# âœ… End of Analysis
print("ðŸš€ Mouse RNA-Seq Analysis Complete!")


```